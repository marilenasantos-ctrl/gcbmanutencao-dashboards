<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Abastecimento - GCB (Clicável)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS para ler arquivos Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    /* Cabeçalho bem leve, como no print */
    header {
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    header h1 {
      font-size: 20px;
      margin: 0 0 4px;
      color: #065f46;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
    }

    .upload-area {
      background: #ecfdf5; /* verde bem clarinho */
      color: #065f46;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      border: 1px solid #a7f3d0;
      max-width: 100%;
      white-space: nowrap;
    }

    .upload-area input[type="file"] {
      cursor: pointer;
      font-size: 12px;
    }

    /* NOME FIXO DO ARQUIVO AO LADO DO BOTÃO */
    .file-fixed-name {
      font-size: 12px;
      font-weight: 600;
      color: #065f46;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    main {
      padding: 20px 24px 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 8px;
      color: #111827;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: 0.06em;
    }

    .card-value {
      font-size: 22px;
      font-weight: 700;
      color: #065f46;
    }

    .card-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .filters-panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px 18px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
      margin-top: 18px;
    }

    .filters-panel > strong {
      font-size: 13px;
      color: #111827;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
      margin-top: 10px;
      align-items: end;
    }

    .filter-group label {
      font-size: 11px;
      color: #4b5563;
      display: block;
      margin-bottom: 3px;
    }

    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #f9fafb;
      outline: none;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #bbf7d0;
    }

    .filter-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn-primary {
      background: #22c55e;
      color: #ffffff;
      box-shadow: 0 2px 4px rgba(22,163,74,0.4);
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .filter-badge {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .filter-badge span {
      font-weight: 600;
      color: #065f46;
    }

    .grid-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 20px;
      margin-top: 16px;
    }

    .panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px 18px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }

    .panel h3 {
      margin: 0 0 4px;
      font-size: 14px;
      color: #111827;
    }

    .panel small {
      color: #9ca3af;
      font-size: 11px;
    }

    canvas {
      width: 100% !important;
      max-height: 340px;
    }

    .table-container {
      margin-top: 10px;
      max-height: 420px;
      overflow: auto;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 700px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
      border-bottom: 1px solid #e5e7eb;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      font-size: 11px;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #ecfdf5;
    }

    .footer-note {
      margin-top: 18px;
      font-size: 11px;
      color: #6b7280;
    }

    .file-name {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
      text-align: right;
    }

    @media (max-width: 900px) {
      .grid-layout {
        grid-template-columns: 1fr;
      }

      .upload-area {
        flex-wrap: wrap;
        white-space: normal;
      }

      .file-fixed-name {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Dashboard de Abastecimento</h1>
      <p>Relatório Geral - Análise de Litros, Valores, Placas, Postos e Centro de Custo</p>
    </div>

    <div>
      <div class="upload-area">
        <span><strong>1.</strong> Selecione o arquivo Excel atualizado:</span>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <!-- NOME FIXO QUE SÓ MUDA QUANDO VOCÊ TROCA O ARQUIVO -->
        <span id="fileFixedName" class="file-fixed-name">Nenhum arquivo selecionado</span>
      </div>
      <div class="file-name" id="fileName">Nenhum arquivo carregado</div>
    </div>
  </header>

  <main>
    <div class="section-title">Resumo Geral</div>
    <div class="cards">
      <div class="card">
        <div class="card-title">Total abastecido (litros)</div>
        <div class="card-value" id="totalLitros">-</div>
        <div class="card-sub">Soma de todos os abastecimentos</div>
      </div>
      <div class="card">
        <div class="card-title">Valor total (R$)</div>
        <div class="card-value" id="valorTotal">-</div>
        <div class="card-sub">Soma do campo "Valor Total"</div>
      </div>
      <div class="card">
        <div class="card-title">Preço médio por litro (R$/L)</div>
        <div class="card-value" id="precoMedio">-</div>
        <div class="card-sub">Valor Total / Litros</div>
      </div>
      <div class="card">
        <div class="card-title">Qtde. de abastecimentos</div>
        <div class="card-value" id="qtdAbastecimentos">-</div>
        <div class="card-sub">Número de linhas do relatório (após filtros)</div>
      </div>
    </div>

    <div class="filters-panel">
      <strong>Filtros clicáveis</strong>
      <div class="filters-grid">
        <!-- ORDEM: Centro de Custo, Placa, Posto, Período, Ações -->
        <div class="filter-group">
          <label for="filtroCentro">Centro de Custo</label>
          <select id="filtroCentro">
            <option value="">(Todos)</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filtroPlaca">Placa</label>
          <select id="filtroPlaca">
            <option value="">(Todas)</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filtroPosto">Posto</label>
          <select id="filtroPosto">
            <option value="">(Todos)</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Período (Data de Abastecimento)</label>
          <div style="display:flex; gap:6px;">
            <input type="date" id="filtroDataIni">
            <input type="date" id="filtroDataFim">
          </div>
        </div>

        <div class="filter-group">
          <label>Ações</label>
          <div class="filter-actions">
            <button class="btn btn-primary" id="btnAplicar">Aplicar filtros</button>
            <button class="btn btn-secondary" id="btnLimpar">Limpar</button>
          </div>
        </div>
      </div>

      <div class="filter-badge" id="filtroResumo">
        Nenhum filtro aplicado. Clique nos gráficos ou use os campos acima para filtrar.
      </div>
    </div>

    <div class="section-title">Análises Gráficas</div>
    <div class="grid-layout">
      <div class="panel">
        <h3>Evolução Mensal (Valor Total)</h3>
        <small>Clique em uma barra para filtrar por mês</small>
        <canvas id="chartMensal"></canvas>
      </div>
      <div class="panel">
        <h3>Top 10 Placas por Litros</h3>
        <small>Clique em uma barra para filtrar por placa</small>
        <canvas id="chartPlacas"></canvas>
      </div>
    </div>

    <div class="grid-layout" style="margin-top: 20px;">
      <div class="panel">
        <h3>Consumo por Posto (Valor Total)</h3>
        <small>Top 10 "Nome do Posto" por valor</small>
        <canvas id="chartPostos"></canvas>
      </div>
      <div class="panel">
        <h3>Consumo por Centro de Custo (Valor Total)</h3>
        <small>Top 10 "Centro de Custo"</small>
        <canvas id="chartCentro"></canvas>
      </div>
    </div>

    <div class="section-title">Tabela de Dados (Relatório Geral)</div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nome do Posto</th>
            <th>Centro de Custo</th>
            <th>Data de Abastecimento</th>
            <th>Hora</th>
            <th>Placa</th>
            <th>Produto</th>
            <th>Litros</th>
            <th>Valor Litro</th>
            <th>Valor Total</th>
          </tr>
        </thead>
        <tbody id="dataBody">
          <!-- Linhas preenchidas via JS -->
        </tbody>
      </table>
    </div>

    <div class="footer-note">
      • Para atualizar o dashboard, basta selecionar um novo arquivo Excel com a mesma estrutura de colunas da aba "Relatório Geral".<br />
      • Você pode combinar filtros (ex.: um Centro de Custo específico + período de datas + uma placa).
    </div>
  </main>

  <script>
    let dadosOriginais = [];
    let dadosFiltrados = [];
    let chartMensal = null;
    let chartPlacas = null;
    let chartPostos = null;
    let chartCentro = null;

    const fileInput = document.getElementById('fileInput');
    const fileNameEl = document.getElementById('fileName');
    const fileFixedName = document.getElementById('fileFixedName');
    const filtroResumo = document.getElementById('filtroResumo');

    fileInput.addEventListener('change', handleFile, false);
    document.getElementById('btnAplicar').addEventListener('click', aplicarFiltros);
    document.getElementById('btnLimpar').addEventListener('click', limparFiltros);

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      // NOME FIXO AO LADO DO BOTÃO (fica até você trocar o arquivo)
      fileFixedName.textContent = file.name;

      fileNameEl.textContent = 'Carregando: ' + file.name + ' ...';

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });

        dadosOriginais = jsonData;
        dadosFiltrados = [...dadosOriginais];

        fileNameEl.textContent = 'Arquivo carregado: ' + file.name + ' (Aba: ' + firstSheetName + ')';
        preencherFiltros(dadosOriginais);
        processarDados(dadosFiltrados);
        filtroResumo.textContent = 'Nenhum filtro aplicado (mostrando todos os registros).';
      };
      reader.readAsArrayBuffer(file);
    }

    function preencherFiltros(dados) {
      const placasSet = new Set();
      const postosSet = new Set();
      const centrosSet = new Set();

      dados.forEach(l => {
        if (l['Placa']) placasSet.add(l['Placa']);
        if (l['Nome do Posto']) postosSet.add(l['Nome do Posto']);
        if (l['Centro de Custo']) centrosSet.add(l['Centro de Custo']);
      });

      preencherSelect('filtroPlaca', placasSet);
      preencherSelect('filtroPosto', postosSet);
      preencherSelect('filtroCentro', centrosSet);
    }

    function preencherSelect(id, setValores) {
      const select = document.getElementById(id);
      const valorAtual = select.value;
      select.innerHTML = '<option value="">(Todos)</option>';

      Array.from(setValores)
        .sort((a, b) => a.toString().localeCompare(b.toString(), 'pt-BR'))
        .forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });

      if (valorAtual && setValores.has(valorAtual)) {
        select.value = valorAtual;
      }
    }

    function aplicarFiltros() {
      if (!dadosOriginais.length) {
        alert('Carregue um arquivo primeiro.');
        return;
      }

      const placaSel = document.getElementById('filtroPlaca').value;
      const postoSel = document.getElementById('filtroPosto').value;
      const centroSel = document.getElementById('filtroCentro').value;
      const dataIni = document.getElementById('filtroDataIni').value;
      const dataFim = document.getElementById('filtroDataFim').value;

      dadosFiltrados = dadosOriginais.filter(l => {
        const placaOk = !placaSel || l['Placa'] === placaSel;
        const postoOk = !postoSel || l['Nome do Posto'] === postoSel;
        const centroOk = !centroSel || l['Centro de Custo'] === centroSel;

        let dataOk = true;
        const d = parseDataExcel(l['Data de Abastecimento']);
        if (dataIni) {
          const di = new Date(dataIni + 'T00:00:00');
          if (!d || d < di) dataOk = false;
        }
        if (dataFim) {
          const df = new Date(dataFim + 'T23:59:59');
          if (!d || d > df) dataOk = false;
        }

        return placaOk && postoOk && centroOk && dataOk;
      });

      processarDados(dadosFiltrados);
      atualizarResumoFiltroTexto();
    }

    function limparFiltros() {
      document.getElementById('filtroPlaca').value = '';
      document.getElementById('filtroPosto').value = '';
      document.getElementById('filtroCentro').value = '';
      document.getElementById('filtroDataIni').value = '';
      document.getElementById('filtroDataFim').value = '';

      dadosFiltrados = [...dadosOriginais];
      processarDados(dadosFiltrados);
      filtroResumo.textContent = 'Nenhum filtro aplicado (mostrando todos os registros).';
    }

    function atualizarResumoFiltroTexto(extra) {
      const placaSel = document.getElementById('filtroPlaca').value;
      const postoSel = document.getElementById('filtroPosto').value;
      const centroSel = document.getElementById('filtroCentro').value;
      const dataIni = document.getElementById('filtroDataIni').value;
      const dataFim = document.getElementById('filtroDataFim').value;

      let partes = [];
      // ORDEM DO RESUMO: Centro de Custo, Placa, Posto
      if (centroSel) partes.push(`Centro de Custo: <span>${centroSel}</span>`);
      if (placaSel) partes.push(`Placa: <span>${placaSel}</span>`);
      if (postoSel) partes.push(`Posto: <span>${postoSel}</span>`);
      if (dataIni || dataFim) {
        partes.push(`Período: <span>${dataIni || 'início'} até ${dataFim || 'fim'}</span>`);
      }

      if (extra) partes.push(extra);

      if (!partes.length) {
        filtroResumo.innerHTML = 'Nenhum filtro aplicado (mostrando todos os registros).';
      } else {
        filtroResumo.innerHTML = 'Filtros ativos → ' + partes.join(' | ');
      }
    }

    function processarDados(dados) {
      if (!Array.isArray(dados) || dados.length === 0) {
        atualizarResumo([]);
        atualizarTabela([]);
        atualizarGraficos([]);
        return;
      }

      atualizarResumo(dados);
      atualizarTabela(dados);
      atualizarGraficos(dados);
    }

    function atualizarResumo(dados) {
      let totalLitros = 0;
      let valorTotal = 0;

      dados.forEach(linha => {
        const litros = Number(linha['Litros']) || 0;
        const valorLinha = Number(linha['Valor Total']) || 0;
        totalLitros += litros;
        valorTotal += valorLinha;
      });

      const precoMedio = totalLitros > 0 ? (valorTotal / totalLitros) : 0;

      document.getElementById('totalLitros').textContent = totalLitros.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      document.getElementById('valorTotal').textContent = valorTotal.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });

      document.getElementById('precoMedio').textContent = precoMedio.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 3
      });

      document.getElementById('qtdAbastecimentos').textContent = dados.length.toLocaleString('pt-BR');
    }

    function atualizarTabela(dados) {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = '';

      const LIMITE_LINHAS = 1000;
      const linhasExibir = dados.slice(0, LIMITE_LINHAS);

      linhasExibir.forEach(linha => {
        const tr = document.createElement('tr');

        const nomePosto = linha['Nome do Posto'] ?? '';
        const centroCusto = linha['Centro de Custo'] ?? '';
        const dataAbastecimento = formatarDataBrasil(linha['Data de Abastecimento']);
        const horaAbastecimento = formatarHoraBrasil(linha['Hora Abastecimento']); // HORA CERTA
        const placa = linha['Placa'] ?? '';
        const produto = linha['Produto'] ?? '';
        const litros = Number(linha['Litros']) || 0;
        const valorLitro = Number(linha['Valor Litro']) || 0;
        const valorTotal = Number(linha['Valor Total']) || 0;

        tr.innerHTML = `
          <td>${nomePosto}</td>
          <td>${centroCusto}</td>
          <td>${dataAbastecimento}</td>
          <td>${horaAbastecimento}</td>
          <td>${placa}</td>
          <td>${produto}</td>
          <td>${litros.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td>${valorLitro.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 3 })}</td>
          <td>${valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    function atualizarGraficos(dados) {
      if (chartMensal) chartMensal.destroy();
      if (chartPlacas) chartPlacas.destroy();
      if (chartPostos) chartPostos.destroy();
      if (chartCentro) chartCentro.destroy();

      const agrupMensal = {};
      const placas = {};
      const postos = {};
      const centros = {};

      dados.forEach(linha => {
        const data = parseDataExcel(linha['Data de Abastecimento']);
        if (data) {
          const chaveMes = data.getFullYear() + '-' + String(data.getMonth() + 1).padStart(2, '0');
          const valorLinha = Number(linha['Valor Total']) || 0;
          agrupMensal[chaveMes] = (agrupMensal[chaveMes] || 0) + valorLinha;
        }

        const placa = (linha['Placa'] || '').toString();
        const litros = Number(linha['Litros']) || 0;
        if (placa) {
          placas[placa] = (placas[placa] || 0) + litros;
        }

        const posto = (linha['Nome do Posto'] || '').toString();
        const valorLinha = Number(linha['Valor Total']) || 0;
        if (posto) {
          postos[posto] = (postos[posto] || 0) + valorLinha;
        }

        const centro = (linha['Centro de Custo'] || '').toString();
        if (centro) {
          centros[centro] = (centros[centro] || 0) + valorLinha;
        }
      });

      const mesesOrdenados = Object.keys(agrupMensal).sort();
      const valoresMes = mesesOrdenados.map(m => agrupMensal[m]);

      const verdeBar = 'rgba(22, 163, 74, 0.5)';
      const verdeBorda = 'rgba(22, 163, 74, 1)';

      const ctxMensal = document.getElementById('chartMensal').getContext('2d');
      chartMensal = new Chart(ctxMensal, {
        type: 'bar',
        data: {
          labels: mesesOrdenados,
          datasets: [{
            label: 'Valor Total (R$)',
            data: valoresMes,
            backgroundColor: verdeBar,
            borderColor: verdeBorda,
            borderWidth: 1.5,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const idx = elements[0].index;
              const mes = mesesOrdenados[idx];
              filtrarPorMes(mes);
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const valor = ctx.parsed.y || 0;
                  return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { autoSkip: true, maxTicksLimit: 12 },
              grid: { display: false }
            },
            y: {
              ticks: {
                callback: function (value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              },
              grid: { color: '#e5e7eb' }
            }
          }
        }
      });

      const topPlacas = Object.entries(placas)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const labelsPlacas = topPlacas.map(([placa]) => placa);
      const dadosPlacas = topPlacas.map(([, litros]) => litros);

      const ctxPlacas = document.getElementById('chartPlacas').getContext('2d');
      chartPlacas = new Chart(ctxPlacas, {
        type: 'bar',
        data: {
          labels: labelsPlacas,
          datasets: [{
            label: 'Litros',
            data: dadosPlacas,
            backgroundColor: verdeBar,
            borderColor: verdeBorda,
            borderWidth: 1.5,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const idx = elements[0].index;
              const placa = labelsPlacas[idx];
              document.getElementById('filtroPlaca').value = placa;
              aplicarFiltros();
              atualizarResumoFiltroTexto('Selecionado pela placa do gráfico.');
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const valor = ctx.parsed.x || 0;
                  return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' L';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: function (value) {
                  return value.toLocaleString('pt-BR');
                }
              },
              grid: { color: '#e5e7eb' }
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });

      const topPostos = Object.entries(postos)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const labelsPostos = topPostos.map(([posto]) => posto);
      const dadosPostos = topPostos.map(([, valor]) => valor);

      const ctxPostos = document.getElementById('chartPostos').getContext('2d');
      chartPostos = new Chart(ctxPostos, {
        type: 'bar',
        data: {
          labels: labelsPostos,
          datasets: [{
            label: 'Valor Total (R$)',
            data: dadosPostos,
            backgroundColor: verdeBar,
            borderColor: verdeBorda,
            borderWidth: 1.5,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const valor = ctx.parsed.y || 0;
                  return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: '#e5e7eb' }
            },
            y: {
              ticks: {
                callback: function (value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              },
              grid: { display: false }
            }
          }
        }
      });

      const topCentro = Object.entries(centros)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      const labelsCentro = topCentro.map(([centro]) => centro);
      const dadosCentro = topCentro.map(([, valor]) => valor);

      const ctxCentro = document.getElementById('chartCentro').getContext('2d');
      chartCentro = new Chart(ctxCentro, {
        type: 'bar',
        data: {
          labels: labelsCentro,
          datasets: [{
            label: 'Valor Total (R$)',
            data: dadosCentro,
            backgroundColor: verdeBar,
            borderColor: verdeBorda,
            borderWidth: 1.5,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const valor = ctx.parsed.x || 0;
                  return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: function (value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              },
              grid: { color: '#e5e7eb' }
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function filtrarPorMes(mesStr) {
      if (!dadosOriginais.length) return;

      const [ano, mes] = mesStr.split('-').map(Number);

      dadosFiltrados = dadosOriginais.filter(l => {
        const d = parseDataExcel(l['Data de Abastecimento']);
        if (!d) return false;
        return d.getFullYear() === ano && (d.getMonth() + 1) === mes;
      });

      processarDados(dadosFiltrados);
      atualizarResumoFiltroTexto(`Mês: <span>${mesStr}</span> (clicado no gráfico mensal)`);
    }

    /* ---------- FUNÇÕES DE DATA & HORA ---------- */

    function parseDataExcel(valor) {
      if (!valor) return null;

      if (Object.prototype.toString.call(valor) === '[object Date]') {
        return isNaN(valor.getTime()) ? null : valor;
      }

      if (typeof valor === 'number') {
        const d = XLSX.SSF.parse_date_code ? XLSX.SSF.parse_date_code(valor) : null;
        if (d) {
          return new Date(d.y, d.m - 1, d.d);
        }
        return null;
      }

      const str = valor.toString();
      const d = new Date(str);
      if (!isNaN(d.getTime())) return d;

      const partes = str.split('/');
      if (partes.length === 3) {
        const dia = parseInt(partes[0], 10);
        const mes = parseInt(partes[1], 10) - 1;
        const ano = parseInt(partes[2], 10);
        const data = new Date(ano, mes, dia);
        if (!isNaN(data.getTime())) return data;
      }

      return null;
    }

    function formatarDataBrasil(valor) {
      const d = parseDataExcel(valor);
      if (!d) return '';
      return d.toLocaleDateString('pt-BR');
    }

    // Formata HORA (número do Excel -> HH:MM:SS)
    function formatarHoraBrasil(valor) {
      if (valor == null || valor === '') return '';

      if (typeof valor === 'number') {
        const totalSegundos = Math.round(valor * 24 * 60 * 60);
        const horas = Math.floor(totalSegundos / 3600);
        const minutos = Math.floor((totalSegundos % 3600) / 60);
        const segundos = totalSegundos % 60;

        const h = String(horas).padStart(2, '0');
        const m = String(minutos).padStart(2, '0');
        const s = String(segundos).padStart(2, '0');
        return `${h}:${m}:${s}`;
      }

      if (Object.prototype.toString.call(valor) === '[object Date]') {
        if (isNaN(valor.getTime())) return '';
        return valor.toLocaleTimeString('pt-BR', { hour12: false });
      }

      const str = valor.toString();
      if (str.includes(':')) {
        return str.length === 5 ? str + ':00' : str;
      }

      return str;
    }
  </script>
</body>
</html>
